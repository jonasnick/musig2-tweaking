\newif\iffull % false is IACR submission
\newif\iffull % false is IACR submission
\documentclass[a4paper,orivec,oribibl,english]{llncs}
\usepackage[top = 3 cm , bottom = 3 cm , left = 3 cm , right = 3 cm]{geometry}

%----PACKAGES-------------------

% \usepackage[notref,notcite,color]{showkeys}

\usepackage{etex}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage[english]{babel}
\usepackage{fancyvrb}
\usepackage{fvextra}
\usepackage{csquotes}

\usepackage{todonotes}

\usepackage{xspace}
\usepackage{mathdots}
\usepackage{array}
\usepackage{subeqnarray}
\usepackage{tabularx}
\usepackage{multirow,makecell}
\usepackage{amsmath}
\usepackage{amssymb}
\let\proof\relax % trick to combine amsthm with llncs - amsthm is useful for \qedhere
\let\endproof\relax
\usepackage{amsthm} % don't load it when using LNCS style, unless using the relax trick
\usepackage{breqn} % load breqn this after ams packages, https://tex.stackexchange.com/a/325264
\usepackage{bm}

% LaTeX positions the subscripts slightly deeper if a superscript is present
% (and ' is just short for ^{\prime}, so it's a superscript).
% This makes equations like h_{agg} = h'_{agg} look strange, and we have lots
% of them and similar math in the ROM proof.
% The normal fix is to write h^{}_{agg} = h'_{agg} but that doesn't work for our
% \hagg etc. macros because it could lead to double superscripts.
% The subdepth package simply makes all subscript the same depth.
% That's somewhat inelegant because it's a global change but it looks good in practice.
\usepackage[low-sup]{subdepth}

\iffull % for changelog
\usepackage[iso]{isodate}
\fi

\usepackage{placeins}
% \usepackage{enumerate}  % load enumerate OR enumitem
\usepackage{enumitem}  % allows to stop and resume a list
% \usepackage{listings} % use listings OR tcolorbox with listings library
\usepackage{tcolorbox}
\tcbuselibrary{listings}
\usepackage{microtype}
\usepackage{url}
\urlstyle{same}
\usepackage[normalem]{ulem}
% \usepackage{algorithm}
% \usepackage{algpseudocode}
\usepackage{thm-restate}

\usepackage{changepage}                 % adjust margins for selected portions
% wide page for side by side figures, tables, etc
\newlength{\offsetpage}
\iffull
\setlength{\offsetpage}{0cm}
\else
\setlength{\offsetpage}{2.0cm}
\fi
\newenvironment{widepage}{\begin{adjustwidth}{-\offsetpage}{-\offsetpage}%
    \addtolength{\textwidth}{2\offsetpage}}%
  {\end{adjustwidth}}

\usepackage{tikz}
\usepgflibrary[arrows]
\usetikzlibrary{arrows,decorations.pathreplacing}
\usetikzlibrary{calc}
\usetikzlibrary{positioning}
\usetikzlibrary{shapes.geometric}

% \usepackage[pdftex]{color,graphicx,rotating}  % don't load it if tikz is loaded 
\graphicspath{{figs/}}
\DeclareGraphicsExtensions{.jpg,.png,.pdf}
\pdfcompresslevel=9


% Fix LNCS template to produce bookmarks for single paper
% https://tex.stackexchange.com/a/47410/61094
\usepackage{etoolbox}
\makeatletter
\let\llncs@addcontentsline\addcontentsline
\patchcmd{\maketitle}{\addcontentsline}{\llncs@addcontentsline}{}{}
\patchcmd{\maketitle}{\addcontentsline}{\llncs@addcontentsline}{}{}
\patchcmd{\maketitle}{\addcontentsline}{\llncs@addcontentsline}{}{}
\setcounter{tocdepth}{2}
\makeatother
\usepackage{hyperref}
\usepackage{bookmark}

\hypersetup{
  colorlinks=true,
  citecolor=blue,
  linkcolor=blue,
  urlcolor=blue,
  bookmarksopen,
  bookmarksdepth=3,
}


\usepackage[
  backend=bibtex,
  style=alphabetic,
  minalphanames=3,
  maxalphanames=3,
  giveninits=true,
  maxbibnames=99,
  date=year
]{biblatex}


\usepackage[lambda,
            advantage,
            adversary,
            probability,
            operators,
            keys,
            asymptotics,
            sets]{cryptocode}
\renewcommand{\pckeystyle}[1]{{\ensuremath{\mathit{\protect\vphantom{p}#1}}}}

\usepackage{nccfoots}

\input{macros}


\begin{document}
\author{
  Jonas Nick\inst{1} \and
  Tim Ruffing\inst{1} \and
  Yannick Seurin\inst{2}
 }
 \institute{
 Blockstream \and
 ANSSI, Paris, France\iffull \\[1.5ex]
  \email{
  jonas@n-ck.net \\
  crypto@timruffing.de \\
  yannick.seurin@m4x.org
  }
 \fi
}

\title{
    A Note on Unforgeability of MuSig2 with Tweaking
}
\maketitle

\begin{abstract}
\emph{Key Tweaking} refers to the process of producing a new pair of secret and public key from a given pair.
This is used, for example, to derive fresh keys from a master keypair or to commit to a value in a public key.
In this note, we show that a variant of $\musigtwo$ with naive tweaking is insecure and propose a variant that is not vulnerable against the attack.

\end{abstract}

\section{The Vulnerable Scheme}
TODO: fix nu everywhere
TODO
This is MuSig with some version of tweaking.
weak because attacker only has control over the contract, not the tweak.
TODO: what is tweaking
For simplicity only two nonces
See Figure \ref{fig:ms}.
\begin{figure}
 \begin{tcolorbox}[boxsep=-1mm]
  \begin{pchstack}[center]
   \begin{pcvstack}
    \procedure{$\setup(\secparam)$}{%
      \gparam \gets \grgen(\secparam) \\
      \text{Select three hash functions}\\
      \t \Hagg, \Hnon, \Hsig:\str\to\integ_p\\
      \param \defeq (\gparam, \Hagg, \Hnon, \Hsig)\\
      \pcreturn \param
    }
    \pcvspace
    \procedure{$\keygen()$}{%
      % (p,\GG,g) \defeq \param \\
      x \sample \ZZ_p \pcsc X \defeq g^x \\
      \sk \defeq x \pcsc \pk \defeq X \\
      \pcreturn (\sk,\pk)
    }
    \pcvspace
    \procedure{$\musigcoef(L,X_i)$}{%
      \pcreturn \Hagg(L,X_i)
    }
    \pcvspace
    \procedure{$\keyagg(L)$}{%
      \{X_1,\ldots,X_n\} \defeq L \\
      \pcfor i \defeq 1 \ldots n \pcdo \\
      \t a_i \defeq \musigcoef(L,X_i)\\
      \pcreturn \tX \defeq \sprod_{i=1}^n X_i^{a_i}
    }
    \pcvspace
    \procedure{$\ver(\apk,m,\sigma)$}{%
      % (p,\GG,g) \defeq \param \\
      \tX \defeq \apk \pcsc (R,s) \defeq \sigma \\
      c \defeq \Hsig(\tX,R,m) \\
      \pcreturn (g^s = R \tX^c)
    }
    \pcvspace
    \procedure{$\sign()$}{%
%       (p,\GG,g) \defeq \param \\
      \pclinecomment{Local signer has index $1$.} \\
      \pcfor j \defeq 1 \ldots \nu \pcdo \\
        \t r_{1,j} \sample \ZZ_p \pcsc R_{1,j} \defeq g^{r_{1,j}} \\
      \msg_1 \defeq (R_{1,1},\ldots,R_{1,\nu}) \\
      \state_1 \defeq (r_{1,1},\ldots,r_{1,\nu}) \\
      \pcreturn (\msg_1,\state_1)
    }
   \end{pcvstack}
   \iffull \pchspace[5em] \else \pchspace[0.7em] \fi
   \begin{pcvstack}
   \procedure{$\signagg(\msg_1,\ldots,\msg_n)$}{%
     \pcfor i \defeq 1 \ldots n \pcdo \\
     \t (R_{i,1}, \ldots, R_{i,\nu}) \defeq \msg_i\\
     \pcfor j \defeq 1 \ldots \nu \pcdo \\
     \t R_j \defeq \sprod_{i=1}^n R_{i,j}\\
     \pcreturn \msg \defeq (R_1, \ldots, R_\nu)
    }
    \pcvspace
    \procedure{$\sign'(\state_1,\msg,\sk_1,m,(\pk_2,\ldots,\pk_n), \mathmod{C})$}{%
      \pclinecomment{$\sign'$ must be called at most once per $\state_1$.} \\
      (r_{1,1},\ldots,r_{1,\nu}) \defeq \state_1 \\
      x_1 \defeq \sk_1 \pcsc X_1' \defeq g^{x_1} \pcsc \mathmod{t \defeq \Ht(X_1', C) \pcsc X_1 \defeq X_1' g^t} \\
      (X_2, \ldots, X_n) \defeq (\pk_2, \ldots, \pk_n)\\
      L \defeq \{X_1,\ldots,X_n\} \\
      a_1 \defeq \musigcoef(L,X_1)\\
      \tX \defeq \keyagg(L)\\
      (R_1,\ldots,R_\nu) \defeq \msg\\
      b \defeq \Hnon(\tX,(R_1,\ldots,R_\nu),m) \\
      R \defeq \sprod_{j=1}^{\nu} R_j^{b^{j-1}} \\
      c \defeq \Hsig(\tX,R,m) \\
      s_1 \defeq c a_1 \mathmod{(x_1 + t)} + \ssum_{i=1}^{\nu} r_{1,j} b^{j-1} \bmod p \\
      \state'_1 \defeq R \pcsc \msg'_1 \defeq s_1 \\
      \pcreturn (\state'_1,\msg'_1)
    }
    \pcvspace
    \procedure{$\signagg'(\msg'_1,\ldots,\msg'_n)$}{%
      (s_1, \ldots, s_n) \defeq (\msg'_1, \ldots, \msg'_n)\\
      s \defeq \ssum_{i=1}^n s_i \bmod p \\
      \pcreturn \msg' \defeq s
    }
    \pcvspace
    \procedure{$\sign''(\state'_1,\msg')$}{%
      R \defeq \state'_1 \pcsc s \defeq \msg'\\
      \pcreturn \sigma \defeq (R,s)
    }
   \end{pcvstack}
  \end{pchstack}
 \end{tcolorbox}
 \caption{The multi-signature scheme $\musigtwontweak[\grgen,\nu]$. The differences to $\musigtwo[\grgen,\nu]$ are displayed in \textmod{red}.}
 \label{fig:ms}
\end{figure}

\section{Generalized Birthday Problem}
The attack against $\musigtwontweak$ makes use of Wagner's algorithm for solving the Generalized Birthday Problem
It can be defined as follows for the purpose of this paper:
Given a constant value $t\in\integ_p$, an integer $\smax$,
and access to random oracle $H$ mapping onto $\integ_p$,
find a set $\{q_1, \ldots, q_{\smax}\}$ of $\smax$ queries such that
\(
  \sum_{\si=1}^{\smax} H(q_{\si}) = t.
\)
For $\smax = 2^{\sqrt{\log_2(p)}-1}$ the complexity of this algorithm is $O(2^{2\sqrt{\log_2(p)}})$.
\jnote{Perhaps can use BLOR? ``If the attacker is able to open more sessions concurrently, the improved polynomial-time attack by Benhamouda \emph{et al.}~\cite{add:BLOR20} assumes $\smax > \log_2 p$ sessions, but then has complexity $O(\smax \log_2 p)$ and a negligible running time in practice.''}

\section{Description of the Attack against $\musigtwontweak$}

The adversary first draws $\lmax \in O(2^{2\sqrt{\log_2(p)}})$ values $C^{(1)}, \ldots, C^{(\lmax)}$ at random and computes tweaks $t^{(\ell)} = \Ht(X_1', C^{(\ell)})$ for all $\ell \in [1,\lmax]$.
Let  $L = \{X_1'g^{t^{(1)}}, \ldots, X_1'g^{t^{(\lmax)}}\}$ be the multiset of public keys and  $\tX=\keyagg(L)$ be the corresponding aggregate public key.

The adversary opens $\smax = 2^{\sqrt{\log_2(p)}-1}$ concurrent signing sessions by requesting $\smax$ nonce pairs $R_{1,1}^{(1)}, R_{1,2}^{(1)}, \ldots, R_{1,1}^{(\smax)}, R_{1,2}^{(\smax)}$ from the honest signer with (untweaked) public key $X_1'=g^{x_1}$.
Given $R_1 = \sum_{\si=1}^\smax R_{1,1}^{(\si)}, R_2 = \sum_{\si=1}^\smax R_{1,2}^{(\si)}$ and a forgery target message $m^*$, the adversary computes $b = \Hnon(\tX,(R_1,R_2),m)$ and $R^*  =  \prod_{\si=1}^{\smax} R_{1,1}^{(\si)} (R_{1,2}^{(\si)})^b$.
and uses Wagner's algorithm to find a value $C^{(\ell)}, \ell \in [1, \lmax]$ for each session $\si$ (in other words a function $f:[1, \smax] \rightarrow [1,\lmax]$) such that
TODO

\begin{equation}\label{eq:wagner-musig}
  \sum_{\si=1}^{\smax} \underbrace{\Hagg(L, X_1'g^{t^{(f(\si))}})}_{=:\,a_1^{(\si)}} \underbrace{\Hsig(\tX, R^*, m)}_{=:\,c^{(\si)}}
  = \underbrace{\Hsig(X_1', R^*, m^*)}_{=:\,c^*} .
\end{equation}
The honest signer will reply with $\kmax$ partial signatures $s_1^{(\si)} = r_{1,1}^{(\si)} + b r_{1,2}^{(\si)} +  c^{(\si)} \cdot a_1^{(\si)} (x_1 + t^{(f(\si))})$ which allows the adversary to compute
\begin{align}\label{eq:s-sum}
  s_1^{*'} &=  \sum_{\si=1}^\smax s_1^{(\si)}\\
  &= \sum_{\si=1}^\smax r_{1,1}^{(\si)} br_{1,2}^{(\si)} +  \left(\sum_{\si=1}^\smax c^{(\si)} a_1^{(\si)}\right) \cdot x_1 + \sum_{\si=1}^\smax c^{(\si)} a_1^{(\si)}t^{(f(\si))} \\
  &= \log_g(R^*) +  c^* x_1 + \sum_{\si=1}^\smax c^{(\si)} a_1^{(\si)}t^{(f(\si))}
\end{align}
where the last equality follows from Equation~\eqref{eq:wagner-musig}.
Then the adversary can subtract the unwanted term as follows
\[
  s_1^* =  s_1^{*'} - \sum_{\si=1}^\smax c^{(\si)} a_1^{(\si)}t^{(f(\si))}
\]
to obtain $(R^*, s^*)$, a valid forgery on message $m^*$ for public key $X_1'$.

\section{Where the security proof of $\musigtwo$ fails against $\musigtwontweak$}
TODO
Look at ROM proof of MuSig (section)
We have a != a but b = b

\section{Tweaking in MuSig2 without }
TODO
Section's bla and blub indicate that is secure when
Make sure that attacker can not choose the signers pubkey after seeing the signers nonces.
Here, adversary can have full control over $t$.

\begin{figure}
 \begin{tcolorbox}[boxsep=-1mm]
  \begin{pchstack}[center]
   \begin{pcvstack}
    \procedure{$\setup(\secparam)$}{%
      \gparam \gets \grgen(\secparam) \\
      \text{Select three hash functions}\\
      \t \Hagg, \Hnon, \Hsig:\str\to\integ_p\\
      \param \defeq (\gparam, \Hagg, \Hnon, \Hsig)\\
      \pcreturn \param
    }
    \pcvspace
    \procedure{$\keygen()$}{%
      % (p,\GG,g) \defeq \param \\
      x \sample \ZZ_p \pcsc X \defeq g^x \\
      \sk \defeq x \pcsc \pk \defeq X \\
      \pcreturn (\sk,\pk)
    }
    \pcvspace
    \procedure{$\musigcoef(L,X_i)$}{%
      \pcreturn \Hagg(L,X_i)
    }
    \pcvspace
    \procedure{$\keyagg(L)$}{%
      \{X_1,\ldots,X_n\} \defeq L \\
      \pcfor i \defeq 1 \ldots n \pcdo \\
      \t a_i \defeq \musigcoef(L,X_i)\\
      \pcreturn \tX \defeq \sprod_{i=1}^n X_i^{a_i}
    }
    \pcvspace
    \procedure{$\ver(\apk,m,\sigma)$}{%
      % (p,\GG,g) \defeq \param \\
      \tX \defeq \apk \pcsc (R,s) \defeq \sigma \\
      c \defeq \Hsig(\tX,R,m) \\
      \pcreturn (g^s = R \tX^c)
    }
    \pcvspace
    \procedure{$\sign(\mathmod{\sk_1, t})$}{%
%       (p,\GG,g) \defeq \param \\
      \pclinecomment{Local signer has index $1$.} \\
      \pcfor j \defeq 1 \ldots \nu \pcdo \\
        \t r_{1,j} \sample \ZZ_p \pcsc R_{1,j} \defeq g^{r_{1,j}} \\
      \msg_1 \defeq (R_{1,1},\ldots,R_{1,\nu}) \\
      \state_1 \defeq (r_{1,1},\ldots,r_{1,\nu}, \mathmod{\sk_1 + t \bmod p}) \\
      \pcreturn (\msg_1,\state_1)
    }
   \end{pcvstack}
   \iffull \pchspace[5em] \else \pchspace[0.7em] \fi
   \begin{pcvstack}
   \procedure{$\signagg(\msg_1,\ldots,\msg_n)$}{%
     \pcfor i \defeq 1 \ldots n \pcdo \\
     \t (R_{i,1}, \ldots, R_{i,\nu}) \defeq \msg_i\\
     \pcfor j \defeq 1 \ldots \nu \pcdo \\
     \t R_j \defeq \sprod_{i=1}^n R_{i,j}\\
     \pcreturn \msg \defeq (R_1, \ldots, R_\nu)
    }
    \pcvspace
    \procedure{$\sign'(\state_1,\msg,\mathmod{\sk_1},m,(\pk_2,\ldots,\pk_n))$}{%
      \pclinecomment{$\sign'$ must be called at most once per $\state_1$.} \\
      (r_{1,1},\ldots,r_{1,\nu}, \mathmod{x_1}) \defeq \state_1 \\
      X_1 \defeq g^{x_1} \\
      (X_2, \ldots, X_n) \defeq (\pk_2, \ldots, \pk_n)\\
      L \defeq \{X_1,\ldots,X_n\} \\
      a_1 \defeq \musigcoef(L,X_1)\\
      \tX \defeq \keyagg(L)\\
      (R_1, \ldots, R_\nu) \defeq \msg\\
      b \defeq \Hnon(\tX,(R_1,\ldots,R_{\nu}),m) \\
      R \defeq \sprod_{j=1}^{\nu} R_j^{b^{j-1}} \\
      c \defeq \Hsig(\tX,R,m) \\
      s_1 \defeq c a_1 x_1 + \ssum_{i=1}^{\nu} r_{1,j} b^{j-1} \bmod p \\
      \state'_1 \defeq R \pcsc \msg'_1 \defeq s_1 \\
      \pcreturn (\state'_1,\msg'_1)
    }
    \pcvspace
    \procedure{$\signagg'(\msg'_1,\ldots,\msg'_n)$}{%
      (s_1, \ldots, s_n) \defeq (\msg'_1, \ldots, \msg'_n)\\
      s \defeq \ssum_{i=1}^n s_i \bmod p \\
      \pcreturn \msg' \defeq s
    }
    \pcvspace
    \procedure{$\sign''(\state'_1,\msg')$}{%
      R \defeq \state'_1 \pcsc s \defeq \msg'\\
      \pcreturn \sigma \defeq (R,s)
    }
   \end{pcvstack}
  \end{pchstack}
 \end{tcolorbox}
 \caption{The multi-signature scheme $\musigtwotweak[\grgen,\nu]$. The differences to $\musigtwo[\grgen,\nu]$ are displayed in \textmod{red}.}
 \label{fig:ms}
\end{figure}

\section{Conclusion}
- Other multisigs and fix?
    - MuSig1, PoP, FROST
- looses freedom for the dev


\end{document}